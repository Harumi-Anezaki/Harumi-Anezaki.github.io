<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>18</title>
</head>
<body>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>半自動 P2P配信</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 700px;
            background-color: #fff;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1, h2 {
            text-align: center;
            color: #1a1a1a;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        video {
            width: 100%;
            background-color: #000;
            border-radius: 8px;
            border: 1px solid #ddd;
            aspect-ratio: 16 / 9;
        }
        .hidden {
            display: none;
        }
        .step {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        .step h3 {
            margin-top: 0;
            color: #007bff;
        }
        .step p {
            margin-bottom: 15px;
        }
        textarea, input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .info-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .info-box input {
            flex-grow: 1;
        }
        .info-box button {
            width: auto;
            flex-shrink: 0;
            font-size: 0.9em;
            padding: 10px 15px;
        }
        .status {
            text-align: center;
            padding: 15px;
            background-color: #e9f7ef;
            color: #146c43;
            border: 1px solid #a3cfbb;
            border-radius: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>半自動 P2P映像配信</h1>

        <!-- 配信者用ビュー -->
        <div id="streamer-view" class="hidden">
            <h2>配信者画面</h2>
            <video id="local-video" autoplay muted playsinline></video>
            
            <div id="streamer-step1" class="step">
                <h3>ステップ1: 視聴用リンクの作成</h3>
                <p>下のボタンを押してカメラを起動し、視聴者に共有するための専用リンクを生成します。</p>
                <button id="create-link-button">視聴用リンクを作成</button>
            </div>

            <div id="streamer-step2" class="step hidden">
                <h3>ステップ2: リンクの共有と接続</h3>
                <p><strong>このリンクを視聴者に共有してください。</strong></p>
                <div class="info-box">
                    <input type="text" id="viewer-link" readonly>
                    <button id="copy-link-button">コピー</button>
                </div>
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                <p><strong>視聴者から受け取った接続情報を下に貼り付けてください。</strong></p>
                <textarea id="answer-input" placeholder="ここに接続情報を貼り付け"></textarea>
                <button id="connect-button">接続する</button>
            </div>
        </div>

        <!-- 視聴者用ビュー -->
        <div id="viewer-view" class="hidden">
            <h2>視聴者画面</h2>
            <video id="remote-video" autoplay playsinline></video>
            
            <div id="viewer-step" class="step">
                <div id="viewer-wait" class="status">
                    配信者からの情報を受信中...
                </div>
                <div id="viewer-ready" class="hidden">
                    <h3>接続情報を配信者に渡してください</h3>
                    <p>下の情報をすべてコピーし、配信者に送ってください。配信者が情報を入力すると、映像の受信が始まります。</p>
                    <div class="info-box">
                        <input type="text" id="answer-output" readonly>
                        <button id="copy-answer-button">コピー</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.onload = () => {
            const pcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
            let pc;

            // URLのハッシュ(#)を見て役割を決定
            if (window.location.hash) {
                setupViewerView();
            } else {
                setupStreamerView();
            }

            // --- 配信者側の処理 ---
            function setupStreamerView() {
                document.getElementById('streamer-view').classList.remove('hidden');
                const localVideo = document.getElementById('local-video');
                const createLinkBtn = document.getElementById('create-link-button');
                const connectBtn = document.getElementById('connect-button');
                const copyLinkBtn = document.getElementById('copy-link-button');

                createLinkBtn.onclick = async () => {
                    try {
                        createLinkBtn.disabled = true;
                        createLinkBtn.textContent = 'カメラを起動中...';
                        
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                        localVideo.srcObject = stream;

                        pc = new RTCPeerConnection(pcConfig);
                        stream.getTracks().forEach(track => pc.addTrack(track, stream));

                        // ICE Candidate収集が完了するのを待つ
                        const offerPromise = new Promise(resolve => {
                            pc.onicegatheringstatechange = () => {
                                if (pc.iceGatheringState === 'complete') {
                                    resolve();
                                }
                            };
                        });

                        const offer = await pc.createOffer();
                        await pc.setLocalDescription(offer);
                        
                        await offerPromise; // 収集完了を待機

                        const offerSdp = btoa(JSON.stringify(pc.localDescription));
                        const viewerLink = `${window.location.href}#${offerSdp}`;
                        
                        document.getElementById('viewer-link').value = viewerLink;
                        document.getElementById('streamer-step1').classList.add('hidden');
                        document.getElementById('streamer-step2').classList.remove('hidden');

                    } catch (e) {
                        alert('カメラの起動に失敗しました。ブラウザのアクセス許可を確認してください。');
                        console.error(e);
                        createLinkBtn.disabled = false;
                        createLinkBtn.textContent = '視聴用リンクを作成';
                    }
                };

                copyLinkBtn.onclick = () => {
                    const linkInput = document.getElementById('viewer-link');
                    linkInput.select();
                    document.execCommand('copy');
                    copyLinkBtn.textContent = 'コピー完了!';
                    setTimeout(() => { copyLinkBtn.textContent = 'コピー'; }, 2000);
                };

                connectBtn.onclick = async () => {
                    try {
                        const answerSdp = document.getElementById('answer-input').value;
                        if (!answerSdp) {
                            alert('接続情報を入力してください。');
                            return;
                        }
                        const answer = JSON.parse(atob(answerSdp));
                        await pc.setRemoteDescription(answer);
                        connectBtn.disabled = true;
                        connectBtn.textContent = '接続済み';
                    } catch (e) {
                        alert('接続に失敗しました。情報が正しいか確認してください。');
                        console.error(e);
                    }
                };
            }

            // --- 視聴者側の処理 ---
            async function setupViewerView() {
                document.getElementById('viewer-view').classList.remove('hidden');
                const remoteVideo = document.getElementById('remote-video');
                const copyAnswerBtn = document.getElementById('copy-answer-button');

                try {
                    const offerSdp = window.location.hash.substring(1);
                    const offer = JSON.parse(atob(offerSdp));

                    pc = new RTCPeerConnection(pcConfig);
                    pc.ontrack = (event) => {
                        if (remoteVideo.srcObject !== event.streams[0]) {
                            remoteVideo.srcObject = event.streams[0];
                        }
                    };

                    // ICE Candidate収集が完了するのを待つ
                    const answerPromise = new Promise(resolve => {
                        pc.onicegatheringstatechange = () => {
                            if (pc.iceGatheringState === 'complete') {
                                resolve();
                            }
                        };
                    });

                    await pc.setRemoteDescription(offer);
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    await answerPromise; // 収集完了を待機

                    const answerOutput = document.getElementById('answer-output');
                    answerOutput.value = btoa(JSON.stringify(pc.localDescription));
                    
                    document.getElementById('viewer-wait').classList.add('hidden');
                    document.getElementById('viewer-ready').classList.remove('hidden');

                } catch (e) {
                    alert('接続情報の読み込みに失敗しました。リンクが正しいか確認してください。');
                    console.error(e);
                }

                copyAnswerBtn.onclick = () => {
                    const answerInput = document.getElementById('answer-output');
                    answerInput.select();
                    document.execCommand('copy');
                    copyAnswerBtn.textContent = 'コピー完了!';
                    setTimeout(() => { copyAnswerBtn.textContent = 'コピー'; }, 2000);
                };
            }
        };
    </script>

</body>
</html>
</body>
</html>